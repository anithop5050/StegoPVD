<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Steganography Detector</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class'
    }
  </script>
  <style>
    /* --- Base Dark Theme --- */
    body { font-family: 'Inter', sans-serif; background: #0d1117; color: #c9d1d9; transition: background-color 0.5s, color 0.5s; position: relative; }
    body::before { content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: radial-gradient(circle at 1px 1px, rgba(0, 255, 255, 0.1) 1px, transparent 0); background-size: 25px 25px; opacity: 0.5; pointer-events: none; z-index: -1; }
    
    /* --- Light Mode --- */
    html.dark body { background: #f0f2f5; color: #24292e; }
    html.dark body::before { background-image: radial-gradient(circle at 1px 1px, rgba(0, 0, 0, 0.1) 1px, transparent 0); }
    
    /* --- Glassmorphism Container --- */
    .glass { background: rgba(31, 41, 55, 0.5); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-radius: 1rem; border: 1px solid rgba(0, 255, 255, 0.2); box-shadow: 0 0 40px rgba(0, 255, 255, 0.1); }
    html.dark .glass { background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(0, 0, 0, 0.1); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); }
    
    /* --- Animations --- */
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    
    /* --- Buttons and Interactive Elements --- */
    .btn-primary { background: linear-gradient(45deg, #00aaff, #00ffaa); color: #0d1117; font-weight: bold; box-shadow: 0 0 20px rgba(0, 220, 220, 0.5); transition: all 0.3s ease; }
    .btn-primary:hover { background: linear-gradient(45deg, #00ffaa, #00aaff); box-shadow: 0 0 30px rgba(0, 255, 255, 0.7); transform: translateY(-3px) scale(1.05); }
    .btn-primary:disabled { background: #374151; color: #6b7280; box-shadow: none; transform: none; cursor: not-allowed; }
    html.dark .btn-primary { background: linear-gradient(45deg, #007bff, #00c6ff); color: white; box-shadow: 0 0 15px rgba(0, 123, 255, 0.4); }
    
    .drop-zone { border: 2px dashed rgba(0, 255, 255, 0.3); color: #9ca3af; transition: all 0.3s ease; }
    .drop-zone:hover { border-color: #00ffff; background-color: rgba(0, 255, 255, 0.05); color: #e5e7eb; }
    html.dark .drop-zone { border-color: rgba(0,0,0,0.2); color: #6b7280; }
    html.dark .drop-zone:hover { border-color: #007bff; background-color: rgba(0,0,0,0.02); }

    /* --- IMAGE PREVIEW FIX --- */
    .image-preview-container {
        border: 1px solid rgba(0, 255, 255, 0.3);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.1);
        max-height: 200px; /* Adjust this value as needed, 200px or 180px might be better */
        padding: 10px; /* Add some padding inside the container */
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.2);
        overflow: hidden; /* Ensures nothing spills out */
    }
    .image-preview-container img {
        max-width: 100%; /* Ensure image doesn't overflow horizontally */
        max-height: 100%; /* Ensure image doesn't overflow vertically */
        object-fit: contain;
    }
    html.dark .image-preview-container { border-color: rgba(0,0,0,0.2); box-shadow: 0 0 15px rgba(0,123,255,0.1); }
    
    /* --- Results Display --- */
    .result-box { background: rgba(0,0,0,0.2); border-left: 4px solid; padding-left: 1rem; }
    .result-box.clean { border-color: #34d399; }
    .result-box.stego { border-color: #f87171; }
    html.dark .result-box { background: #e9ecef; }

    .result-class-name.clean { color: #34d399; text-shadow: 0 0 8px #34d399;}
    .result-class-name.stego { color: #f87171; text-shadow: 0 0 8px #f87171;}
    html.dark .result-class-name.clean, html.dark .result-class-name.stego { text-shadow: none; }
    
    /* --- Confidence Bar Styles --- */
    .confidence-bar-container { background-color: #374151; border-radius: 9999px; height: 12px; overflow: hidden; margin-top: 10px; }
    html.dark .confidence-bar-container { background-color: #d1d5db; }

    .confidence-bar {
        height: 100%;
        border-radius: 9999px;
        transition: width 0.8s ease-out;
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    .confidence-bar.clean { background: linear-gradient(90deg, #10b981, #34d399); }
    .confidence-bar.stego { background: linear-gradient(90deg, #ef4444, #f87171); }
    html.dark .confidence-bar { box-shadow: none; }

    
    /* --- Navigation Bar --- */
    .navbar { background: rgba(13, 17, 23, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0, 255, 255, 0.2); z-index: 100; }
    .nav-link { color: #c9d1d9; transition: color 0.3s, text-shadow 0.3s; padding-bottom: 4px; }
    .nav-link:hover { color: #00ffff; text-shadow: 0 0 5px #00ffff; }
    html.dark .navbar { background: rgba(255, 255, 255, 0.8); border-bottom: 1px solid rgba(0, 0, 0, 0.1); }
    html.dark .nav-link { color: #24292e; }
    html.dark .nav-link:hover { color: #007bff; text-shadow: none; }

    /* --- Animated Processing Indicator --- */
    @keyframes pulse { 50% { opacity: .5; } }
    .processing-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
  </style>
</head>

<body class="min-h-screen">
   <nav class="navbar fixed top-0 left-0 right-0 h-16 flex items-center justify-between px-4 sm:px-8">
        <div class="text-xl font-bold text-cyan-400">
            Stego<span class="text-gray-400">PVD</span>
        </div>
       <div class="flex items-center space-x-6">
            <a href="{{ url_for('home') }}" class="nav-link">Home</a>
            <a href="{{ url_for('steganography_page') }}" class="nav-link">Steganography</a>
        </div>
    </nav>
  
  <div class="flex items-center justify-center px-4 py-10 pt-20 min-h-screen w-full">
    <div class="glass w-full max-w-xl p-8 shadow-2xl text-center z-10 relative mt-16">
      
      <div class="flex justify-end mb-4">
        <label class="inline-flex items-center cursor-pointer">
          <span class="mr-2 text-sm font-medium text-gray-400">üåô</span>
          <input type="checkbox" id="toggleMode" class="sr-only peer">
          <div class="w-10 h-5 bg-gray-700 rounded-full peer-checked:bg-cyan-500 relative transition-all duration-300">
            <div class="absolute left-1 top-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-300 peer-checked:translate-x-5"></div>
          </div>
          <span class="ml-2 text-sm font-medium text-gray-400">‚òÄÔ∏è</span>
        </label>
      </div>

      <h1 class="text-3xl font-bold mb-2 text-cyan-400">üïµÔ∏è Steganography Detector</h1>
      <p class="text-sm text-gray-400 mb-6">Upload an image to check if it contains PVD-encoded data.</p>
      
      <div id="dropZone" class="drop-zone rounded-lg p-6 mb-4">
        Drag & drop an image here or click below
      </div>

      <input id="imageUpload" type="file" accept="image/png,image/jpeg,image/bmp" class="hidden" />
      
      <div id="previewContainer" class="image-preview-container mx-auto hidden rounded-lg mb-2">
        <img id="previewImage" class="rounded-lg" />
      </div>
      <div id="imageInfo" class="text-xs text-gray-500 mb-4 h-4"></div>

      <div id="processing" class="text-blue-400 text-sm mb-2 hidden processing-animation">üß† Analyzing...</div>

      <button id="predictBtn" class="btn-primary px-6 py-2 rounded-lg hidden">Analyze Image</button>
      <button onclick="location.reload()" class="mt-2 text-sm underline text-gray-500 hover:text-cyan-400 transition">Clear</button>

      <div id="result" class="mt-6 text-base font-medium fade-in p-4 rounded-lg hidden"></div>
    </div>
  </div>

  <script>
    // --- JAVASCRIPT FOR FLASK BACKEND COMMUNICATION ---

    // DOM Elements
    const imageInput = document.getElementById("imageUpload");
    const preview = document.getElementById("previewImage");
    const previewContainer = document.getElementById("previewContainer");
    const predictBtn = document.getElementById("predictBtn");
    const resultBox = document.getElementById("result");
    const processing = document.getElementById("processing");
    const imageInfo = document.getElementById("imageInfo");
    const dropZone = document.getElementById("dropZone");
    const toggle = document.getElementById("toggleMode");

    // --- Theme memory and toggle logic ---
    if (localStorage.getItem('theme') === 'light') {
        document.documentElement.classList.add('dark');
        toggle.checked = false;
    } else {
        document.documentElement.classList.remove('dark');
        toggle.checked = true;
    }
    toggle.addEventListener("change", () => {
      document.documentElement.classList.toggle("dark");
      localStorage.setItem('theme', toggle.checked ? 'dark' : 'light');
    });

    // --- Function to handle file selection and display preview ---
    function handleFile(file) {
      if (!file) return;
      const allowedTypes = ["image/png", "image/jpeg", "image/bmp"];
      if (!allowedTypes.includes(file.type)) {
        alert("Please upload a valid image file (.png, .jpg, or .bmp).");
        return;
      }

      preview.src = URL.createObjectURL(file);
      previewContainer.classList.remove("hidden");
      predictBtn.classList.remove("hidden");
      resultBox.innerHTML = "";
      resultBox.classList.add("hidden");
      preview.onload = () => {
        imageInfo.innerHTML = `Dimensions: ${preview.naturalWidth}x${preview.naturalHeight}px`;
      };
    }
    
    // --- CORE PREDICTION FUNCTION (Communicates with Flask) ---
    async function predictFromImage() {
        if (imageInput.files.length === 0) {
            alert('Please select an image first!');
            return;
        }

        const formData = new FormData();
        formData.append('file', imageInput.files[0]);
        
        // Clear the file input *after* adding the file to formData.
        imageInput.value = null;
        
        processing.classList.remove('hidden');
        predictBtn.disabled = true;
        resultBox.classList.add("hidden");

        try {
            const response = await fetch('/predict', { method: 'POST', body: formData });
            if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
            
            const data = await response.json();

            if (data.prediction) {
                const resultClass = data.prediction.toLowerCase();
                // Ensure confidence is a number between 0 and 100
                const confidence = Math.max(0, Math.min(100, data.confidence ? parseFloat(data.confidence).toFixed(2) : 100));
                
                resultBox.className = `result-box mt-6 text-base font-medium fade-in p-4 rounded-lg ${resultClass}`;
                resultBox.innerHTML = `
                    <p class="text-xl font-extrabold mb-3 text-left">
                        <span class="result-class-name ${resultClass}">
                            ${data.prediction === 'CLEAN' ? '‚úÖ CLEAN IMAGE' : 'üö® PVD DETECTED'}
                        </span>
                    </p>
                    <div class="flex justify-between items-center text-sm font-semibold mb-1">
                        <span>Confidence:</span>
                        <span class="text-lg">${confidence}%</span>
                    </div>
                    <div class="confidence-bar-container">
                        <div 
                            class="confidence-bar ${resultClass}" 
                            style="width: ${confidence}%;"
                        ></div>
                    </div>
                `;
            } else {
                resultBox.className = `result-box mt-6 text-base font-medium fade-in p-4 rounded-lg stego`;
                resultBox.innerHTML = `<p class="text-lg font-bold result-class-name stego">Error: ${data.error || 'Unknown error'}</p>`;
            }

        } catch (error) {
            resultBox.className = `result-box mt-6 text-base font-medium fade-in p-4 rounded-lg stego`;
            resultBox.innerHTML = `<p class="text-lg font-bold result-class-name stego">Error: ${error.message}</p>`;
        } finally {
            processing.classList.add('hidden');
            resultBox.classList.remove('hidden');
            predictBtn.disabled = false;
        }
    }

    // --- Event Listeners ---
    predictBtn.addEventListener("click", predictFromImage);
    imageInput.addEventListener("change", () => handleFile(imageInput.files[0]));
    
    // --- Drop Zone Logic ---
    dropZone.addEventListener("click", () => imageInput.click());
    dropZone.addEventListener("dragover", e => { e.preventDefault(); });
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      if (e.dataTransfer.files.length > 0) {
        imageInput.files = e.dataTransfer.files; 
        handleFile(e.dataTransfer.files[0]);
      }
    });

  </script>
</body>
</html>